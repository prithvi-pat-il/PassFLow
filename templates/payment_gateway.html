{% extends "base.html" %}

{% block title %}Payment Gateway - PassFlow{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0">
                    <i class="bi bi-credit-card"></i> Payment Gateway
                </h4>
            </div>
            <div class="card-body">
                <!-- Order Summary -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-receipt"></i> Order Summary</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Location:</strong> {{ pass_data.location }}</p>
                            <p class="mb-1"><strong>Route:</strong> {{ route.name }}</p>
                            <p class="mb-0"><strong>Bus Number:</strong> {{ route.bus_number }}</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5 class="text-success">₹{{ "%.2f"|format(pass_data.amount) }}</h5>
                            <small class="text-muted">Monthly Fee</small>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <form method="POST" action="{{ url_for('process_payment') }}" id="paymentForm">
                    <div class="mb-4">
                        <h6><i class="bi bi-wallet2"></i> Choose Payment Method</h6>
                        <div class="row g-3">
                            <!-- UPI Payment -->
                            <div class="col-md-6">
                                <div class="card payment-method" data-method="UPI">
                                    <div class="card-body text-center">
                                        <i class="bi bi-phone text-primary" style="font-size: 2rem;"></i>
                                        <h6 class="mt-2">UPI Payment</h6>
                                        <p class="text-muted small">Pay via UPI ID or QR Code</p>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_method" 
                                                   id="upi" value="UPI" checked>
                                            <label class="form-check-label" for="upi">Select UPI</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Credit/Debit Card -->
                            <div class="col-md-6">
                                <div class="card payment-method" data-method="Card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-credit-card text-success" style="font-size: 2rem;"></i>
                                        <h6 class="mt-2">Credit/Debit Card</h6>
                                        <p class="text-muted small">Visa, MasterCard, RuPay</p>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_method" 
                                                   id="card" value="Card">
                                            <label class="form-check-label" for="card">Select Card</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UPI QR Code (Demo) -->
                    <div id="upiPayment" class="payment-section">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-qr-code"></i> Scan QR Code to Pay</h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Demo QR Code -->
                                <div class="qr-code-container mb-3">
                                    <img id="qrCodeImg" src="" alt="QR Code" style="width: 200px; height: 200px; border: 2px solid #ddd;">
                                </div>
                                
                                <div class="alert alert-warning">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Demo Mode:</strong> This is a simulation. In production, this would be a real UPI QR code.
                                    </small>
                                </div>
                                
                                <p><strong>UPI ID:</strong> <code>demo@paytm</code></p>
                                <p><strong>Amount:</strong> <span class="h5 text-success">₹{{ "%.2f"|format(pass_data.amount) }}</span></p>
                                
                                <div class="mt-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <small class="text-muted">Waiting for payment confirmation...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Payment (Demo) -->
                    <div id="cardPayment" class="payment-section" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-credit-card"></i> Card Payment Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Card Number</label>
                                            <input type="text" class="form-control" placeholder="**** **** **** 1234" 
                                                   value="4532 1234 5678 9012" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Cardholder Name</label>
                                            <input type="text" class="form-control" value="{{ session.user_name }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Expiry Date</label>
                                            <input type="text" class="form-control" placeholder="MM/YY" 
                                                   value="12/28" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">CVV</label>
                                            <input type="text" class="form-control" placeholder="***" 
                                                   value="123" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Demo Mode:</strong> Pre-filled with demo card details. Real implementation would require user input.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Actions -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <a href="{{ url_for('create_pass') }}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-arrow-left"></i> Back to Route Selection
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success w-100" id="payBtn">
                                <i class="bi bi-check-circle"></i> Complete Payment (Demo)
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethods = document.querySelectorAll('.payment-method');
    const upiSection = document.getElementById('upiPayment');
    const cardSection = document.getElementById('cardPayment');
    const payBtn = document.getElementById('payBtn');
    
    // Payment method selection
    paymentMethods.forEach(method => {
        method.addEventListener('click', function() {
            const methodType = this.dataset.method;
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Remove active class from all methods
            paymentMethods.forEach(m => m.classList.remove('border-primary', 'bg-light'));
            
            // Add active class to selected method
            this.classList.add('border-primary', 'bg-light');
            
            // Show/hide payment sections
            if (methodType === 'UPI') {
                upiSection.style.display = 'block';
                cardSection.style.display = 'none';
            } else {
                upiSection.style.display = 'none';
                cardSection.style.display = 'block';
            }
        });
    });
    
    // Initialize with UPI selected
    document.querySelector('[data-method="UPI"]').click();
    
    // Load QR code
    loadQRCode();
    
    // Demo payment processing
    payBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Show processing state
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing Payment...';
        this.disabled = true;
        
        // Simulate payment processing delay
        setTimeout(() => {
            // Submit the form
            document.getElementById('paymentForm').submit();
        }, 2000);
    });
    
    function loadQRCode() {
        fetch('/generate_qr')
            .then(response => response.text())
            .then(qrData => {
                document.getElementById('qrCodeImg').src = qrData;
            })
            .catch(error => {
                console.error('Error loading QR code:', error);
                // Fallback to placeholder
                document.getElementById('qrCodeImg').src = 'data:image/svg+xml;base64,' + btoa('<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="200" fill="#f8f9fa"/><text x="100" y="100" text-anchor="middle" fill="#6c757d">QR Code</text></svg>');
            });
    }
});
</script>

<style>
.payment-method {
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.qr-code-container {
    display: inline-block;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}
