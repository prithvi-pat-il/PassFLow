{% extends "base.html" %}

{% block title %}Print Passes - Admin Panel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="bi bi-printer"></i> Bulk Pass Printing</h4>
                <p class="mb-0">Generate printable passes for students</p>
            </div>
            <div class="card-body">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3>{{ approved_passes|length }}</h3>
                                <p class="mb-0">Approved Passes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h3>{{ pending_passes|length }}</h3>
                                <p class="mb-0">Pending Passes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3>{{ all_passes|length }}</h3>
                                <p class="mb-0">Total Passes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Print Options -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-funnel"></i> Filter & Print Options</h5>
                    </div>
                    <div class="card-body">
                        <form id="printForm" method="GET" action="{{ url_for('admin_bulk_print') }}" target="_blank">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="status" class="form-label">Pass Status</label>
                                    <select class="form-select" name="status" id="status">
                                        <option value="Approved">Approved Only</option>
                                        <option value="Pending">Pending Only</option>
                                        <option value="All">All Statuses</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="route" class="form-label">Route</label>
                                    <select class="form-select" name="route" id="route">
                                        <option value="All">All Routes</option>
                                        {% for route in routes %}
                                            <option value="{{ route.id }}">{{ route.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="location" class="form-label">Location</label>
                                    <select class="form-select" name="location" id="location">
                                        <option value="All">All Locations</option>
                                        {% for location in locations %}
                                            <option value="{{ location }}">{{ location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-printer"></i> Generate Printable Passes
                                    </button>
                                    <button type="button" class="btn btn-info btn-lg ms-2" onclick="previewCount()">
                                        <i class="bi bi-eye"></i> Preview Count
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <div id="previewCount" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Preview:</strong> <span id="countText"></span> passes will be generated for printing.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5>Quick Print Options</h5>
                        <div class="row">
                            <div class="col-md-6 col-lg-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">All Approved</h5>
                                        <p class="card-text">Print all approved passes</p>
                                        <a href="{{ url_for('admin_bulk_print', status='Approved') }}" 
                                           class="btn btn-success" target="_blank">
                                            <i class="bi bi-printer"></i> Print
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">New This Month</h5>
                                        <p class="card-text">Print recently created passes</p>
                                        <a href="{{ url_for('admin_bulk_print', status='Approved') }}" 
                                           class="btn btn-primary" target="_blank">
                                            <i class="bi bi-printer"></i> Print
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">By Route</h5>
                                        <p class="card-text">Print by specific route</p>
                                        <button class="btn btn-info" onclick="showRouteModal()">
                                            <i class="bi bi-funnel"></i> Select
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Individual Pass</h5>
                                        <p class="card-text">Print single pass by ID</p>
                                        <button class="btn btn-warning" onclick="showPassModal()">
                                            <i class="bi bi-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="alert alert-info mt-4">
                    <h6><i class="bi bi-info-circle"></i> Printing Instructions:</h6>
                    <ul class="mb-0">
                        <li>Use A4 paper for best results</li>
                        <li>Print in color for professional appearance</li>
                        <li>Each pass is designed to fit standard ID card size</li>
                        <li>QR codes are included for verification</li>
                        <li>Cut along the borders for individual passes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Route Selection Modal -->
<div class="modal fade" id="routeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Route</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select class="form-select" id="routeSelect">
                    {% for route in routes %}
                        <option value="{{ route.id }}">{{ route.name }} ({{ route.bus_number }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="printByRoute()">Print Passes</button>
            </div>
        </div>
    </div>
</div>

<!-- Pass ID Modal -->
<div class="modal fade" id="passModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Individual Pass</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="passId" class="form-label">Pass ID or Pass Number</label>
                <input type="text" class="form-control" id="passId" placeholder="Enter pass ID or pass number">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="printByPassId()">Find & Print</button>
            </div>
        </div>
    </div>
</div>

<script>
function previewCount() {
    const form = document.getElementById('printForm');
    const formData = new FormData(form);
    const status = formData.get('status');
    const route = formData.get('route');
    const location = formData.get('location');
    
    // Simple client-side counting logic
    let count = 0;
    let description = [];
    
    if (status === 'Approved') {
        count = {{ approved_passes|length }};
        description.push('approved');
    } else if (status === 'Pending') {
        count = {{ pending_passes|length }};
        description.push('pending');
    } else {
        count = {{ all_passes|length }};
        description.push('all');
    }
    
    if (route !== 'All') {
        description.push('from selected route');
    }
    
    if (location !== 'All') {
        description.push('from ' + location);
    }
    
    document.getElementById('countText').textContent = `Approximately ${count} ${description.join(' ')}`;
    document.getElementById('previewCount').style.display = 'block';
}

function showRouteModal() {
    new bootstrap.Modal(document.getElementById('routeModal')).show();
}

function showPassModal() {
    new bootstrap.Modal(document.getElementById('passModal')).show();
}

function printByRoute() {
    const routeId = document.getElementById('routeSelect').value;
    window.open(`{{ url_for('admin_bulk_print') }}?status=Approved&route=${routeId}`, '_blank');
    bootstrap.Modal.getInstance(document.getElementById('routeModal')).hide();
}

function printByPassId() {
    const passId = document.getElementById('passId').value;
    if (passId) {
        // Redirect to individual pass print
        window.open(`/pass/${passId}/print`, '_blank');
    }
    bootstrap.Modal.getInstance(document.getElementById('passModal')).hide();
}
</script>
{% endblock %}
